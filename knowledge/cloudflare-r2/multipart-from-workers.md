[Skip to content](https://developers.cloudflare.com/r2/api/workers/workers-multipart-usage/#_top)
[ ![](https://developers.cloudflare.com/_astro/logo.DAG2yejx.svg) Cloudflare Docs  ](https://developers.cloudflare.com/)
Search`âŒ˜``K`
[Docs Directory](https://developers.cloudflare.com/directory/)[APIs](https://developers.cloudflare.com/api/)[SDKs](https://developers.cloudflare.com/fundamentals/api/reference/sdks/)Help
[ Log in ](https://dash.cloudflare.com/) Select theme Dark Light Auto
[ **R2** ](https://developers.cloudflare.com/r2/)
No results found. Try a different search term, or use our global search. 
  * [ Overview ](https://developers.cloudflare.com/r2/)
  * [ Getting started ](https://developers.cloudflare.com/r2/get-started/)
  * [ How R2 works ](https://developers.cloudflare.com/r2/how-r2-works/)
  * Data migration
    * [ Overview ](https://developers.cloudflare.com/r2/data-migration/)
    * [ Super Slurper ](https://developers.cloudflare.com/r2/data-migration/super-slurper/)
    * [ Sippy ](https://developers.cloudflare.com/r2/data-migration/sippy/)
    * [ Migration Strategies ](https://developers.cloudflare.com/r2/data-migration/migration-strategies/)
  * Buckets
    * [ Overview ](https://developers.cloudflare.com/r2/buckets/)
    * [ Create new buckets ](https://developers.cloudflare.com/r2/buckets/create-buckets/)
    * [ Public buckets ](https://developers.cloudflare.com/r2/buckets/public-buckets/)
    * [ Configure CORS ](https://developers.cloudflare.com/r2/buckets/cors/)
    * [ Bucket locks ](https://developers.cloudflare.com/r2/buckets/bucket-locks/)
    * [ Event notifications ](https://developers.cloudflare.com/r2/buckets/event-notifications/)
    * [ Object lifecycles ](https://developers.cloudflare.com/r2/buckets/object-lifecycles/)
    * [ Storage classes ](https://developers.cloudflare.com/r2/buckets/storage-classes/)
  * Objects
    * [ Overview ](https://developers.cloudflare.com/r2/objects/)
    * [ Multipart upload ](https://developers.cloudflare.com/r2/objects/multipart-objects/)
    * [ Upload objects ](https://developers.cloudflare.com/r2/objects/upload-objects/)
    * [ Download objects ](https://developers.cloudflare.com/r2/objects/download-objects/)
    * [ Delete objects ](https://developers.cloudflare.com/r2/objects/delete-objects/)
  * API
    * [ Authentication ](https://developers.cloudflare.com/r2/api/tokens/)
    * S3
      * [ S3 API compatibility ](https://developers.cloudflare.com/r2/api/s3/api/)
      * [ Extensions ](https://developers.cloudflare.com/r2/api/s3/extensions/)
      * [ Presigned URLs ](https://developers.cloudflare.com/r2/api/s3/presigned-urls/)
    * Workers API
      * [ Use R2 from Workers ](https://developers.cloudflare.com/r2/api/workers/workers-api-usage/)
      * [ Use the R2 multipart API from Workers ](https://developers.cloudflare.com/r2/api/workers/workers-multipart-usage/)
      * [ Workers API reference ](https://developers.cloudflare.com/r2/api/workers/workers-api-reference/)
  * R2 Data Catalog Beta
    * [ Overview ](https://developers.cloudflare.com/r2/data-catalog/)
    * [ Getting started ](https://developers.cloudflare.com/r2/data-catalog/get-started/)
    * [ Manage catalogs ](https://developers.cloudflare.com/r2/data-catalog/manage-catalogs/)
    * [ About compaction ](https://developers.cloudflare.com/r2/data-catalog/about-compaction/)
    * Connect to Iceberg engines
      * [ Apache Trino ](https://developers.cloudflare.com/r2/data-catalog/config-examples/trino/)
      * [ DuckDB ](https://developers.cloudflare.com/r2/data-catalog/config-examples/duckdb/)
      * [ PyIceberg ](https://developers.cloudflare.com/r2/data-catalog/config-examples/pyiceberg/)
      * [ Snowflake ](https://developers.cloudflare.com/r2/data-catalog/config-examples/snowflake/)
      * [ Spark (PySpark) ](https://developers.cloudflare.com/r2/data-catalog/config-examples/spark-python/)
      * [ Spark (Scala) ](https://developers.cloudflare.com/r2/data-catalog/config-examples/spark-scala/)
      * [ StarRocks ](https://developers.cloudflare.com/r2/data-catalog/config-examples/starrocks/)
  * [ R2 SQL â†— ](https://developers.cloudflare.com/r2-sql/)
  * Examples
    * [ Overview ](https://developers.cloudflare.com/r2/examples/)
    * [ Multi-cloud setup â†— ](https://developers.cloudflare.com/reference-architecture/diagrams/storage/egress-free-storage-multi-cloud/)
    * [ Authenticate against R2 API using auth tokens ](https://developers.cloudflare.com/r2/examples/authenticate-r2-auth-tokens/)
    * [ Rclone ](https://developers.cloudflare.com/r2/examples/rclone/)
    * S3 SDKs
      * [ aws CLI ](https://developers.cloudflare.com/r2/examples/aws/aws-cli/)
      * [ aws-sdk-go ](https://developers.cloudflare.com/r2/examples/aws/aws-sdk-go/)
      * [ aws-sdk-java ](https://developers.cloudflare.com/r2/examples/aws/aws-sdk-java/)
      * [ aws-sdk-js ](https://developers.cloudflare.com/r2/examples/aws/aws-sdk-js/)
      * [ aws-sdk-js-v3 ](https://developers.cloudflare.com/r2/examples/aws/aws-sdk-js-v3/)
      * [ aws-sdk-net ](https://developers.cloudflare.com/r2/examples/aws/aws-sdk-net/)
      * [ aws-sdk-php ](https://developers.cloudflare.com/r2/examples/aws/aws-sdk-php/)
      * [ aws-sdk-ruby ](https://developers.cloudflare.com/r2/examples/aws/aws-sdk-ruby/)
      * [ aws-sdk-rust ](https://developers.cloudflare.com/r2/examples/aws/aws-sdk-rust/)
      * [ aws4fetch ](https://developers.cloudflare.com/r2/examples/aws/aws4fetch/)
      * [ boto3 ](https://developers.cloudflare.com/r2/examples/aws/boto3/)
      * [ Configure custom headers ](https://developers.cloudflare.com/r2/examples/aws/custom-header/)
    * [ Terraform ](https://developers.cloudflare.com/r2/examples/terraform/)
    * [ Terraform (AWS) ](https://developers.cloudflare.com/r2/examples/terraform-aws/)
    * [ Use SSE-C ](https://developers.cloudflare.com/r2/examples/ssec/)
    * [ Use the Cache API ](https://developers.cloudflare.com/r2/examples/cache-api/)
  * [ Tutorials ](https://developers.cloudflare.com/r2/tutorials/)
  * [ Videos â†— ](https://developers.cloudflare.com/learning-paths/r2-intro/series/r2-1/)
  * [ Demos and architectures ](https://developers.cloudflare.com/r2/demos/)
  * Platform
    * [ Choose a storage product â†— ](https://developers.cloudflare.com/workers/platform/storage-options/)
    * [ Audit Logs ](https://developers.cloudflare.com/r2/platform/audit-logs/)
    * [ Limits ](https://developers.cloudflare.com/r2/platform/limits/)
    * [ Metrics and analytics ](https://developers.cloudflare.com/r2/platform/metrics-analytics/)
    * [ Release notes ](https://developers.cloudflare.com/r2/platform/release-notes/)
    * [ Troubleshooting ](https://developers.cloudflare.com/r2/platform/troubleshooting/)
  * Reference
    * [ Consistency model ](https://developers.cloudflare.com/r2/reference/consistency/)
    * [ Data location ](https://developers.cloudflare.com/r2/reference/data-location/)
    * [ Data security ](https://developers.cloudflare.com/r2/reference/data-security/)
    * [ Durability ](https://developers.cloudflare.com/r2/reference/durability/)
    * [ Unicode interoperability ](https://developers.cloudflare.com/r2/reference/unicode-interoperability/)
    * [ Wrangler commands â†— ](https://developers.cloudflare.com/workers/wrangler/commands/#r2-bucket)
  * [ Pricing ](https://developers.cloudflare.com/r2/pricing/)
  * LLM resources
    * [ llms.txt ](https://developers.cloudflare.com/llms.txt)
    * [ prompt.txt ](https://developers.cloudflare.com/workers/prompt.txt)
    * [ R2 llms-full.txt ](https://developers.cloudflare.com/r2/llms-full.txt)
    * [ Developer Platform llms-full.txt ](https://developers.cloudflare.com/developer-platform/llms-full.txt)


[GitHub](https://github.com/cloudflare/cloudflare-docs)[X.com](https://x.com/cloudflare)[YouTube](https://www.youtube.com/cloudflare)
Select theme Dark Light Auto
On this page Overview 
  * [ Overview ](https://developers.cloudflare.com/r2/api/workers/workers-multipart-usage/#_top)
  * [ An example Worker using the multipart API ](https://developers.cloudflare.com/r2/api/workers/workers-multipart-usage/#an-example-worker-using-the-multipart-api)
  * [ Perform a multipart upload with your Worker (optional) ](https://developers.cloudflare.com/r2/api/workers/workers-multipart-usage/#perform-a-multipart-upload-with-your-worker-optional)
  * [ State management ](https://developers.cloudflare.com/r2/api/workers/workers-multipart-usage/#state-management)


## On this page
  * [ Overview ](https://developers.cloudflare.com/r2/api/workers/workers-multipart-usage/#_top)
  * [ An example Worker using the multipart API ](https://developers.cloudflare.com/r2/api/workers/workers-multipart-usage/#an-example-worker-using-the-multipart-api)
  * [ Perform a multipart upload with your Worker (optional) ](https://developers.cloudflare.com/r2/api/workers/workers-multipart-usage/#perform-a-multipart-upload-with-your-worker-optional)
  * [ State management ](https://developers.cloudflare.com/r2/api/workers/workers-multipart-usage/#state-management)

  

## Was this helpful?
  

[ ](https://github.com/cloudflare/cloudflare-docs/edit/production/src/content/docs/r2/api/workers/workers-multipart-usage.mdx) [ ](https://github.com/cloudflare/cloudflare-docs/issues/new/choose)
  1. [ Directory ](https://developers.cloudflare.com/directory/)
  2. â€¦ 
  3. [ R2 ](https://developers.cloudflare.com/r2/)
  4. [ API ](https://developers.cloudflare.com/r2/api/)
  5. [ Workers API ](https://developers.cloudflare.com/r2/api/workers/)
  6. [ Use the R2 multipart API from Workers ](https://developers.cloudflare.com/r2/api/workers/workers-multipart-usage/)


Copy page
# Use the R2 multipart API from Workers
By following this guide, you will create a Worker through which your applications can perform multipart uploads. This example worker could serve as a basis for your own use case where you can add authentication to the worker, or even add extra validation logic when uploading each part. This guide also contains an example Python application that uploads files to this worker.
This guide assumes you have set up the [R2 binding](https://developers.cloudflare.com/workers/runtime-apis/bindings/) for your Worker. Refer to [Use R2 from Workers](https://developers.cloudflare.com/r2/api/workers/workers-api-usage) for instructions on setting up an R2 binding.
## An example Worker using the multipart API
[](https://developers.cloudflare.com/r2/api/workers/workers-multipart-usage/#an-example-worker-using-the-multipart-api)
The following example Worker exposes an HTTP API which enables applications to use the multipart API through the Worker.
In this example, each request is routed based on the HTTP method and the action request parameter. As your Worker becomes more complicated, consider utilizing a serverless web framework such as [Hono â†—](https://honojs.dev/) to handle the routing for you.
The following example Worker includes any new information about the state of the multipart upload in the response to each request. For the request which creates the multipart upload, the `uploadId` is returned. For requests uploading a part, the part number and `etag` are returned. In turn, the client keeps track of this state, and includes the uploadId in subsequent requests, and the `etag` and part number of each part when completing a multipart upload.
Add the following code to your project's `index.js` file and replace `MY_BUCKET` with your bucket's name:
JavaScript```


interfaceEnv{




MY_BUCKET:R2Bucket;



}



exportdefault{




asyncfetch(




request,




env,



ctx



):Promise<Response>{




constbucket=env.MY_BUCKET;




consturl=newURL(request.url);




constkey=url.pathname.slice(1);




constaction=url.searchParams.get("action");




if (action===null) {




returnnewResponse("Missing action type",{ status:400});



}


// Route the request based on the HTTP method and action type



switch (request.method) {




case"POST":




switch (action) {




case"mpu-create":{




constmultipartUpload=awaitbucket.createMultipartUpload(key);




returnnewResponse(




JSON.stringify({




key:multipartUpload.key,




uploadId:multipartUpload.uploadId,




})




);



}



case"mpu-complete":{




constuploadId=url.searchParams.get("uploadId");




if (uploadId===null) {




returnnewResponse("Missing uploadId",{ status:400});



}



constmultipartUpload=env.MY_BUCKET.resumeMultipartUpload(




key,



uploadId



);




interfacecompleteBody{




parts:R2UploadedPart[];



}



constcompleteBody:completeBody=awaitrequest.json();




if (completeBody===null) {




returnnewResponse("Missing or incomplete body",{




status:400,




});



}


// Error handling in case the multipart upload does not exist anymore



try{




constobject=awaitmultipartUpload.complete(completeBody.parts);




returnnewResponse(null,{




headers:{




etag:object.httpEtag,



},



});




}catch(error:any){




returnnewResponse(error.message,{ status:400});



}


}



default:




returnnewResponse(`Unknown action ${action} for POST`,{




status:400,




});



}



case"PUT":




switch (action) {




case"mpu-uploadpart":{




constuploadId=url.searchParams.get("uploadId");




constpartNumberString=url.searchParams.get("partNumber");




if (partNumberString===null||uploadId===null) {




returnnewResponse("Missing partNumber or uploadId",{




status:400,




});



}



if (request.body===null) {




returnnewResponse("Missing request body",{ status:400});



}



constpartNumber=parseInt(partNumberString);




constmultipartUpload=env.MY_BUCKET.resumeMultipartUpload(




key,



uploadId



);




try{




constuploadedPart:R2UploadedPart=




awaitmultipartUpload.uploadPart(partNumber,request.body);




returnnewResponse(JSON.stringify(uploadedPart));




}catch(error:any){




returnnewResponse(error.message,{ status:400});



}


}



default:




returnnewResponse(`Unknown action ${action} for PUT`,{




status:400,




});



}



case"GET":




if (action!=="get") {




returnnewResponse(`Unknown action ${action} for GET`,{




status:400,




});



}



constobject=awaitenv.MY_BUCKET.get(key);




if (object===null) {




returnnewResponse("Object Not Found",{ status:404});



}



constheaders=newHeaders();




object.writeHttpMetadata(headers);




headers.set("etag",object.httpEtag);




returnnewResponse(object.body,{headers});




case"DELETE":




switch (action) {




case"mpu-abort":{




constuploadId=url.searchParams.get("uploadId");




if (uploadId===null) {




returnnewResponse("Missing uploadId",{ status:400});



}



constmultipartUpload=env.MY_BUCKET.resumeMultipartUpload(




key,



uploadId



);




try{




multipartUpload.abort();




}catch(error:any){




returnnewResponse(error.message,{ status:400});



}



returnnewResponse(null,{ status:204});



}



case"delete":{




awaitenv.MY_BUCKET.delete(key);




returnnewResponse(null,{ status:204});



}



default:




returnnewResponse(`Unknown action ${action} for DELETE`,{




status:400,




});



}



default:




returnnewResponse("Method Not Allowed",{




status:405,




headers:{ Allow:"PUT, POST, GET, DELETE"},




});



}


},



}satisfiesExportedHandler<Env>;


```

After you have updated your Worker with the above code, run `npx wrangler deploy`.
You can now use this Worker to perform multipart uploads. You can either send requests from your existing application to this Worker to perform uploads or use a script to upload files through this Worker.
The next section is optional and shows an example of a Python script which uploads a chosen file on your machine to your Worker.
## Perform a multipart upload with your Worker (optional)
[](https://developers.cloudflare.com/r2/api/workers/workers-multipart-usage/#perform-a-multipart-upload-with-your-worker-optional)
This example application uploads a local file to the Worker in multiple parts. It uses Python's built-in `ThreadPoolExecutor` to parallelize the uploading of parts to the Worker, which increases upload speeds. HTTP requests to the Worker are made with the [requests â†—](https://pypi.org/project/requests/) library.
Utilizing the multipart API in this way also allows you to use your Worker to upload files larger than the [Workers request body size limit](https://developers.cloudflare.com/workers/platform/limits#request-limits). The uploading of individual parts is still subject to this limit.
Save the following code in a file named `mpuscript.py` on your local machine. Change the `worker_endpoint variable` to where your worker is deployed. Pass the file you want to upload as an argument when running this script: `python3 mpuscript.py myfile`. This will upload the file `myfile` from your machine to your bucket through the Worker.
Python```


import math




import os




import requests




from requests.adapters import HTTPAdapter, Retry




import sys




import concurrent.futures



# Take the file to upload as an argument



filename = sys.argv[1]



# The endpoint for our worker, change this to wherever you deploy your worker



worker_endpoint ="https://myworker.myzone.workers.dev/"



# Configure the part size to be 10MB. 5MB is the minimum part size, except for the last part



partsize =10*1024*1024




defupload_file(worker_endpoint,filename,partsize):




url =f"{worker_endpoint}{filename}"



# Create the multipart upload



uploadId = requests.post(url,params={"action":"mpu-create"}).json()["uploadId"]




part_count = math.ceil(os.stat(filename).st_size / partsize)



# Create an executor for up to 25 concurrent uploads.



executor = concurrent.futures.ThreadPoolExecutor(25)



# Submit a task to the executor to upload each part



futures =[




executor.submit(upload_part, filename, partsize, url, uploadId, index)




for index inrange(part_count)



]



concurrent.futures.wait(futures)



# get the parts from the futures



uploaded_parts =[future.result()for future in futures]



# complete the multipart upload



response = requests.post(




url,




params={"action":"mpu-complete","uploadId": uploadId},




json={"parts": uploaded_parts},



)



if response.status_code ==200:




print("ðŸŽ‰ successfully completed multipart upload")




else:




print(response.text)




defupload_part(filename,partsize,url,uploadId,index):



# Open the file in rb mode, which treats it as raw bytes rather than attempting to parse utf-8



withopen(filename,"rb")as file:




file.seek(partsize * index)




part = file.read(partsize)



# Retry policy for when uploading a part fails



s = requests.Session()




retries =Retry(total=3,status_forcelist=[400,500,502,503,504])




s.mount("https://", HTTPAdapter(max_retries=retries))




return s.put(




url,




params={




"action":"mpu-uploadpart",




"uploadId": uploadId,




"partNumber": str(index +1),



},



data=part,




).json()




upload_file(worker_endpoint, filename, partsize)


```

## State management
[](https://developers.cloudflare.com/r2/api/workers/workers-multipart-usage/#state-management)
The stateful nature of multipart uploads does not easily map to the usage model of Workers, which are inherently stateless. In a normal multipart upload, the multipart upload is usually performed in one continuous execution of the client application. This is different from multipart uploads in a Worker, which will often be completed over multiple invocations of that Worker. This makes state management more challenging.
To overcome this, the state associated with a multipart upload, namely the `uploadId` and which parts have been uploaded, needs to be kept track of somewhere outside of the Worker.
In the example Worker and Python application described in this guide, the state of the multipart upload is tracked in the client application which sends requests to the Worker, with the necessary state contained in each request. Keeping track of the multipart state in the client application enables maximal flexibility and allows for parallel and unordered uploads of each part.
When keeping track of this state in the client is impossible, alternative designs can be considered. For example, you could track the `uploadId` and which parts have been uploaded in a Durable Object or other database.
## Was this helpful?
[](https://github.com/cloudflare/cloudflare-docs/edit/production/src/content/docs/r2/api/workers/workers-multipart-usage.mdx)
Last updated: Aug 13, 2024
[ Previous   
Use R2 from Workers ](https://developers.cloudflare.com/r2/api/workers/workers-api-usage/) [ Next   
Workers API reference ](https://developers.cloudflare.com/r2/api/workers/workers-api-reference/)
  * **Resources**
  * [ API ](https://developers.cloudflare.com/api/)
  * [ New to Cloudflare? ](https://developers.cloudflare.com/fundamentals/)
  * [ Directory ](https://developers.cloudflare.com/directory/)
  * [ Sponsorships ](https://developers.cloudflare.com/sponsorships/)
  * [ Open Source ](https://github.com/cloudflare)


  * **Support**
  * [ Help Center ](https://support.cloudflare.com/)
  * [ System Status ](https://www.cloudflarestatus.com/)
  * [ Compliance ](https://www.cloudflare.com/trust-hub/compliance-resources/)
  * [ GDPR ](https://www.cloudflare.com/trust-hub/gdpr/)


  * **Company**
  * [ cloudflare.com ](https://www.cloudflare.com/)
  * [ Our team ](https://www.cloudflare.com/people/)
  * [ Careers ](https://www.cloudflare.com/careers/)


  * **Tools**
  * [ Cloudflare Radar ](https://radar.cloudflare.com/)
  * [ Speed Test ](https://speed.cloudflare.com/)
  * [ Is BGP Safe Yet? ](https://isbgpsafeyet.com/)
  * [ RPKI Toolkit ](https://rpki.cloudflare.com/)
  * [ Certificate Transparency ](https://ct.cloudflare.com/)


  * **Community**
  * [ ](https://x.com/cloudflare)
  * [ ](http://discord.cloudflare.com/)
  * [ ](https://www.youtube.com/cloudflare)
  * [ ](https://github.com/cloudflare/cloudflare-docs)


  * Â© 2025 Cloudflare, Inc.
  * [ Privacy Policy ](https://www.cloudflare.com/privacypolicy/)
  * [ Terms of Use ](https://www.cloudflare.com/website-terms/)
  * [ Report Security Issues ](https://www.cloudflare.com/disclosure/)
  * [ Trademark ](https://www.cloudflare.com/trademark/)
  * ![privacy options](https://developers.cloudflare.com/_astro/privacyoptions.BWXSiJOZ_22PXh4.svg) Cookie Settings


Back to top
